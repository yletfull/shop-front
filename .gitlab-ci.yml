image: "gitlab.ubic.tech:4567/docker/node:10.24"

cache:
  key:
    files:
      - yarn.lock
  paths:
    - .yarn
    - node_modules/
  policy: pull

variables:
  REGISTRY_URL: "gitlab.ubic.tech:4567"
  IMAGE_NAME: $REGISTRY_URL/$CI_PROJECT_PATH:$CI_COMMIT_REF_NAME
  COMP_PROJECT_NAME: front
  COMP_PROJECT_DIR: advert-automata

stages:
  - build_cache
  - lint
  - build
  - dockerize
  - deploy

build_cache:
  stage: build_cache
  cache:
    key:
      files:
        - yarn.lock
    paths:
      - .yarn
      - node_modules/
    policy: push
  only:
    changes:
      - yarn.lock
  script:
    - yarn install --cache-folder .yarn

lint:
  stage: lint
  except:
    - tags
  script:
    - yarn install --cache-folder .yarn
    - yarn lint

build:
  stage: build
  only:
    - tags
    - master
    - develop
  script:
    - yarn install --cache-folder .yarn
    - yarn build
  artifacts:
    expire_in: 1 day
    paths:
      - dist/*

dockerize:
  image: docker:latest
  cache: {}
  services:
    - docker:dind
  stage: dockerize
  only:
    - tags
    - master
    - develop
  script:
    - docker login -u gitlab-ci-token -p $CI_JOB_TOKEN $REGISTRY_URL
    - docker build --pull --cache-from $IMAGE_NAME -t $IMAGE_NAME -f Dockerfile .
    - docker push $IMAGE_NAME

deploy:
  stage: deploy
  tags:
    - sandbox-docker
  only:
    - develop
  script:
    - docker-compose -f /opt/docker/docker-compose/$COMP_PROJECT_DIR/docker-compose.yml -f /opt/docker/docker-compose/$COMP_PROJECT_DIR/docker-compose.override.yml --env-file /opt/docker/docker-compose/$COMP_PROJECT_DIR/.env pull  $COMP_PROJECT_NAME
    - docker-compose -f /opt/docker/docker-compose/$COMP_PROJECT_DIR/docker-compose.yml -f /opt/docker/docker-compose/$COMP_PROJECT_DIR/docker-compose.override.yml --env-file /opt/docker/docker-compose/$COMP_PROJECT_DIR/.env up -d $COMP_PROJECT_NAME
